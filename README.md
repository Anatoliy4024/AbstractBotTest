# TelegramBot_PicnicAlicante

## 1. Суть проекта
Проект направлен на автоматическое администрирование организации ивентов. Пользователи взаимодействуют с ботом Telegram, чтобы планировать мероприятия, выбирая даты, время, количество участников, стиль вечеринки и прочие предпочтения.

## 2. Файловая структура
Проект состоит из следующих файлов и директорий:
- `main.py`: Основной файл, запускающий бота и обрабатывающий взаимодействие с пользователями.
- `database_logger.py`: Модуль для логирования операций с базой данных.
- `abstract_functions.py`: Модуль, содержащий вспомогательные функции для работы с базой данных.
- `keyboards.py`: Модуль, создающий различные клавиатуры для взаимодействия с пользователем.
- `view_database.py`: Модуль для просмотра данных из базы данных.
- `sqlite.db`: Файл базы данных SQLite, где хранятся сессии пользователей.
- `message_handlers.py`: Модуль для обработки сообщений и команд.
- `media/`: Директория с видеороликами для приветствия пользователей.

## 3. Архитектура

### 3.1 Принцип каскадности
Принцип каскадности используется для разделения модулей на переменные и постоянные абстракции:
- **Переменные абстракции** учитывают пожелания пользователя и предлагают выбор из различных опций (например, язык, дата, время и т.д.).
- **Постоянные абстракции** выполняют одно повторяющееся действие, такое как запрос подтверждения действия (например, "Введите имя", "Вы выбрали...") и кнопки "Да" и "Нет".

Всего имеется: *на момент разработки документации - 7.08.2024 (предполагается еще 2 переменных и 2 постоянных)
- Переменных абстракций: 7
- Постоянных абстракций: 6

### 3.2 Перечень модулей с их названиями

1. **Модуль 1** (Переменный)
   - Название: `language_selection`
   - Описание: Выбор языка пользователем.
   - Функции: `language_selection_keyboard()`

2. **Модуль 2** (Постоянный)
   - Название: `greeting`
   - Описание: Приветствие пользователю и запрос имени с последующим вопросом.
   - Функции: `handle_name()`

3. **Модуль 3** (Переменный)
   - Название: `date_selection`
   - Описание: Выбор даты мероприятия.
   - Функции: `generate_calendar_keyboard()`, `show_calendar()`

4. **Модуль 4** (Постоянный)
   - Название: `date_confirmation`
   - Описание: Подтверждение выбранной даты.
   - Функции: `disable_calendar_buttons()`

5. **Модуль 5** (Переменный)
   - Название: `time_selection`
   - Описание: Выбор времени мероприятия.
   - Функции: `generate_time_selection_keyboard()`

6. **Модуль 6** (Постоянный)
   - Название: `time_confirmation`
   - Описание: Подтверждение выбранного времени.
   - Функции: `disable_time_buttons()`

7. **Модуль 7** (Переменный)
   - Название: `people_selection`
   - Описание: Выбор количества участников.
   - Функции: `generate_person_selection_keyboard()`

8. **Модуль 8** (Постоянный)
   - Название: `people_confirmation`
   - Описание: Подтверждение количества участников.
   - Функции: `disable_person_buttons()`

9. **Модуль 9** (Переменный)
   - Название: `style_selection`
   - Описание: Выбор стиля мероприятия.
   - Функции: `generate_party_styles_keyboard()`

10. **Модуль 10** (Постоянный)
    - Название: `style_confirmation`
    - Описание: Подтверждение выбранного стиля.
    - Функции: `disable_style_buttons()`

11. **Модуль 11** (Переменный)
    - Название: `preferences_request`
    - Описание: Запрос предпочтений пользователя.
    - Функции: `handle_preferences()`

12. **Модуль 12** (Переменный)
    - Название: `city_request`
    - Описание: Запрос города проведения мероприятия.
    - Функции: `handle_city()`

13. **Модуль 13** (Постоянный)
    - Название: `city_confirmation`
    - Описание: Подтверждение введенного города.
    - Функции: `handle_city_confirmation()`

### 3.3 Принцип взаимодействия файлов

1. **main.py**: Основной файл, запускающий бота и обрабатывающий все взаимодействия с пользователем.
   
   **Анализ файла main.py**:
   Этот файл является основным для вашего проекта и содержит настройки, обработчики команд и обратных вызовов для Telegram-бота. Вот основные элементы:

   1. **Импорт библиотек**:
      - Импортируются необходимые библиотеки, включая библиотеки для работы с Telegram API, базой данных, и вспомогательные функции.

   2. **Логирование**:
      - Логирование настроено для записи в файл `db_operations.log` с уровнем детализации DEBUG.

   3. **Функции для работы с базой данных**:
      - `some_database_operation()`: Пример функции для выполнения SQL-запроса с повторными попытками при блокировке базы данных.
      - `add_username_column()`: Добавляет колонку `username` в таблицу `users`.

   4. **Асинхронные обработчики команд и сообщений**:
      - `start()`: Обрабатывает команду `/start`, сохраняет информацию о пользователе в базу данных и предлагает выбрать язык.
      - `button_callback()`: Обрабатывает нажатия кнопок, управляющих логикой бота, включая выбор языка, времени, даты, количества людей, стиля вечеринки и предпочтений.
      - `show_calendar()`: Показывает календарь для выбора даты.
      - `handle_name()`: Обрабатывает ввод имени пользователя.

   5. **Функции для изменения клавиатур**:
      - `disable_calendar_buttons()`, `disable_time_buttons()`, `disable_person_buttons()`, `disable_style_buttons()`, `disable_yes_no_buttons()`: Отключают кнопки после выбора пользователем.

   6. **Запуск бота**:
      - Приложение инициализируется и запускается с добавлением соответствующих обработчиков команд и сообщений.

2. **database_logger.py**: Содержит функции для логирования операций с базой данных.
   
   **Анализ файла database_logger.py**:
   Этот файл содержит функции для логирования операций с базой данных, а также настройки для логирования. Вот основные элементы:

   1. **Настройка логирования**:
      - Логирование настраивается с использованием модуля `logging`.
      - Логи записываются в файл `db_operations.log` с форматированием, включающим время, уровень логирования и сообщение.
      - Установлена кодировка UTF-8 для корректного отображения символов.

   2. **Функции логирования**:
      - `log_message(message)`: Логирует произвольное сообщение.
      - `log_query(query, params=())`: Логирует SQL-запрос и его параметры.

   3. **`execute_query_with_logging(conn, query, params=())`**:
      - Выполняет SQL-запрос с логированием.
      - Логирует запрос и его параметры перед выполнением.
      - Логирует успешное выполнение запроса или ошибку.

   Этот файл предназначен для отслеживания операций с базой данных, что помогает в отладке и мониторинге выполнения запросов.

3. **abstract_functions.py**: Вспомогательные функции для работы с базой данных.
   
   **Анализ файла abstract_functions.py**:
   Этот файл содержит функции для работы с базой данных SQLite, включая создание соединения, выполнение запросов и повторные попытки выполнения запросов при блокировке базы данных. Вот основные функции, включенные в этот файл:

   1. **`create_connection(db_file)`**:
      - Создает соединение с базой данных SQLite.
      - Логирует успешное подключение или ошибку.

   2. **`execute_query(conn, query, params=())`**:
      - Выполняет SQL-запрос с использованием предоставленного соединения.
      - Логирует запрос, его параметры и результат выполнения.
      - Закрывает соединение после выполнения.

   3. **`execute_query_with_retry(query, params=(), max_retries=5)`**:
      - Выполняет SQL-запрос с повторными попытками при блокировке базы данных.
      - Логирует попытки и результат выполнения.

4. **keyboards.py**: Функции для создания клавиатур в Telegram.
   
   **Анализ файла keyboards.py**:
   Этот файл содержит функции для генерации различных типов клавиатур для взаимодействия с пользователем через Telegram-бота. Вот основные функции:

   1. **`generate_month_name(month, language)`**:
      - Возвращает название месяца на заданном языке.

   2. **`generate_calendar_keyboard(month_offset=0, language='en')`**:
      - Создает календарную клавиатуру для выбора даты.
      - Включает кнопки для навигации по месяцам и выбора дней.

   3. **`generate_time_selection_keyboard(language, stage='start', start_time=None)`**:
      - Создает клавиатуру для выбора времени.
      - Включает кнопки для временных интервалов с различными условиями.

   4. **`language_selection_keyboard()`**:
      - Создает клавиатуру для выбора языка.
      - Включает кнопки для нескольких языков.

   5. **`yes_no_keyboard(language)`**:
      - Создает клавиатуру с кнопками "Да" и "Нет" на выбранном языке.

   6. **`generate_person_selection_keyboard(language)`**:
      - Создает клавиатуру для выбора количества людей.
      - Включает кнопки от 2 до 21.

   7. **`generate_party_styles_keyboard(language)`**:
      - Создает клавиатуру для выбора стиля вечеринки.
      - Включает различные стили для каждого языка.

   Эти функции обеспечивают многоязыковую поддержку и гибкость в создании пользовательских интерфейсов для Telegram-бота.

5. **message_handlers.py**: Содержит обработчики сообщений и команд.
   
   **Анализ файла message_handlers.py**:
   Этот файл содержит обработчики для различных шагов взаимодействия с пользователем, а также вспомогательные функции для управления состояниями и клавиатурами. Вот основные элементы:

   1. **Обработчик текстовых сообщений**:
      - **`handle_message(update, context)`**: Обрабатывает текстовые сообщения в зависимости от текущего шага взаимодействия с пользователем (грейтинга, предпочтений, выбора города и т.д.).

   2. **Функции для обработки конкретных шагов**:
      - **`handle_name(update, context)`**: Обрабатывает ввод имени пользователя и предлагает посмотреть доступные даты.
      - **`handle_preferences(update, context)`**: Обрабатывает ввод предпочтений пользователя и запрашивает город проведения события.
      - **`handle_city(update, context)`**: Обрабатывает ввод города и запрашивает подтверждение.
      - **`handle_city_confirmation(update, context)`**: Обрабатывает подтверждение города и уведомляет пользователя о сохранении данных и расчете стоимости.

   3. **Функция для получения текущей клавиатуры**:
      - **`get_current_step_keyboard(step, user_data)`**: Возвращает соответствующую клавиатуру для текущего шага на основе состояния пользователя.

6. **view_database.py**: Модуль для просмотра данных в базе данных.
   
   **Анализ файла view_database.py**:
   Этот файл содержит функции для просмотра содержимого базы данных SQLite. Основная цель этого файла - упрощение работы с базой данных, предоставляя возможность выводить все записи из таблицы `users`. Вот основные элементы:

   1. **Константа `DATABASE_PATH`**:
      - Определяет путь к базе данных `sqlite.db`.

   2. **Функция `fetch_all_users()`**:
      - Создает соединение с базой данных.
      - Выполняет SQL-запрос для получения всех записей из таблицы `users`.
      - Выводит каждую запись в консоль.
      - Закрывает соединение после выполнения.

   Этот файл позволяет удобно просматривать содержимое таблицы `users`, что полезно для отладки и мониторинга данных.

7. **sqlite.db**: Файл базы данных SQLite, где хранятся сессии пользователей.

8. **media/**: Директория с видеороликами для приветствия пользователей.

## 4. Перечень функций

- `create_connection(db_file)`: Создает соединение с базой данных SQLite.
- `execute_query_with_logging(conn, query, params=())`: Выполняет SQL-запрос с логированием.
- `log_message(message)`: Логирует сообщение.
- `log_query(query, params=())`: Логирует SQL-запрос.
- `generate_calendar_keyboard(month_offset=0, language='en')`: Генерирует клавиатуру с календарем.
- `generate_time_selection_keyboard(language, stage='start', start_time=None)`: Генерирует клавиатуру для выбора времени.
- `language_selection_keyboard()`: Генерирует клавиатуру для выбора языка.
- `yes_no_keyboard(language)`: Генерирует клавиатуру с кнопками "Да" и "Нет".
- `generate_person_selection_keyboard(language)`: Генерирует клавиатуру для выбора количества участников.
- `generate_party_styles_keyboard(language)`: Генерирует клавиатуру для выбора стиля мероприятия.
- `handle_name(update, context)`: Обрабатывает ввод имени пользователя.
- `show_calendar(query, month_offset, language)`: Показывает календарь для выбора даты.
- `disable_calendar_buttons(reply_markup, selected_date)`: Деактивирует кнопки календаря.
- `disable_time_buttons(reply_markup, selected_time)`: Деактивирует кнопки времени.
- `disable_person_buttons(reply_markup, selected_person)`: Деактивирует кнопки количества участников.
- `disable_style_buttons(reply_markup, selected_style)`: Деактивирует кнопки стиля.
- `disable_yes_no_buttons(reply_markup)`: Деактивирует кнопки "Да" и "Нет".
- `handle_preferences(update, context)`: Обрабатывает ввод предпочтений пользователя.
- `handle_city(update, context)`: Обрабатывает ввод города проведения мероприятия.
- `handle_city_confirmation(update, context)`: Подтверждает введенный город.
- `fetch_all_users()`: Получает и выводит всех пользователей из базы данных.
